- name: Create the directory
  file: path={{ redis_backup_dir }} state=directory recurse=yes
  

- set_fact:
    redis_backup_file_name: "redis-backup-{{ lookup('pipe', 'date +%Y%m%d') }}.rdb"
 
- set_fact:
    redis_backup_file_path: "{{ redis_backup_dir }}/{{ redis_backup_file_name }}"


- name: copy dump.rdb file
  copy:
    src: /home/learning/redis-stable/dump.rdb
    dest: "{{ redis_backup_dir }}/{{ redis_backup_file_name }}"
    remote_src: yes
    

#- name: upload to azure
  #include_role:
    #name: artifacts-upload-azure
  #vars:
    #artifact: "{{ redis_backup_file_name }}"
    #artifact_path: "{{ redis_backup_file_path }}"
    #artifacts_container: "{{ redis_backup_azure_container_name }}"

- name: Upload to azure blob storage
  command: "az storage blob upload --name {{ redis_backup_file_name }} --file {{ redis_backup_file_path }} --container-name {{ redis_backup_azure_container_name }}"
  #environment:
  #  AZURE_STORAGE_ACCOUNT: "{{ backup_azure_storage_account_name }}"
  #  AZURE_STORAGE_KEY: "{{ backup_azure_storage_access_key }}"
  async: 3600
  poll: 10
   
- name: clean up backup dir after upload
  file: path={{ redis_backup_dir }} state=absent
